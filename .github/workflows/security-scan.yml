name: Security Scanning

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Backend npm audit
        working-directory: backend
        run: |
          echo "üîç Running npm audit on backend..."
          npm audit --audit-level=moderate > backend-audit.txt || true
          cat backend-audit.txt
        continue-on-error: true
      
      - name: Frontend npm audit
        working-directory: frontend
        run: |
          echo "üîç Running npm audit on frontend..."
          npm audit --audit-level=moderate > frontend-audit.txt || true
          cat frontend-audit.txt
        continue-on-error: true
      
      - name: Install Snyk
        run: npm install -g snyk
      
      - name: Snyk backend scan
        working-directory: backend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üîç Running Snyk scan on backend..."
          snyk test --severity-threshold=high || true
        continue-on-error: true
      
      - name: Snyk frontend scan
        working-directory: frontend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üîç Running Snyk scan on frontend..."
          snyk test --severity-threshold=high || true
        continue-on-error: true
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-results
          path: |
            backend-audit.txt
            frontend-audit.txt
          retention-days: 30

  code-security-scan:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci
      
      - name: ESLint security scan (backend)
        working-directory: backend
        run: |
          echo "üîç Running ESLint security checks..."
          npm run lint || true
        continue-on-error: true
      
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ESLint security scan (frontend)
        working-directory: frontend
        run: |
          echo "üîç Running ESLint security checks..."
          npm run lint || true
        continue-on-error: true
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  owasp-zap-scan:
    name: OWASP ZAP Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'https://staging.yourapp.com'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true
      
      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: report_html.html
          retention-days: 30

  secrets-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true
      
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  security-headers-check:
    name: Security Headers Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check security headers
        run: |
          echo "üîç Checking security headers..."
          
          # Function to check headers
          check_headers() {
            URL=$1
            echo "Checking: $URL"
            curl -s -D - $URL -o /dev/null | grep -i -E "(x-frame-options|x-content-type-options|strict-transport-security|content-security-policy|x-xss-protection)"
          }
          
          # Check staging environment
          check_headers "https://staging.yourapp.com" || echo "‚ö†Ô∏è  Some security headers missing"
          check_headers "https://api-staging.yourapp.com/health" || echo "‚ö†Ô∏è  Some API security headers missing"

  penetration-tests:
    name: Automated Penetration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
        working-directory: backend
      
      - name: Run security tests
        working-directory: backend
        env:
          TEST_API_URL: https://api-staging.yourapp.com
          TEST_USER_EMAIL: test@example.com
          TEST_USER_PASSWORD: TestPassword123!
        run: |
          echo "üß™ Running automated penetration tests..."
          npm run test:security || true
        continue-on-error: true

  security-report:
    name: Generate Security Report
    needs: [dependency-scan, code-security-scan, secrets-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Date**: $(date)" >> security-summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> security-summary.md
          echo "**Commit**: ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Scans Completed" >> security-summary.md
          echo "- ‚úÖ Dependency scan: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- ‚úÖ Code security scan: ${{ needs.code-security-scan.result }}" >> security-summary.md
          echo "- ‚úÖ Secrets scan: ${{ needs.secrets-scan.result }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "View detailed reports in workflow artifacts." >> security-summary.md
          
          cat security-summary.md
      
      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
        continue-on-error: true
      
      - name: Notify on failure
        if: |
          needs.dependency-scan.result == 'failure' ||
          needs.code-security-scan.result == 'failure' ||
          needs.secrets-scan.result == 'failure'
        run: |
          echo "‚ö†Ô∏è  Security scans detected issues"
          # Uncomment to send Slack notification
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"üö® Security scan detected vulnerabilities! Check GitHub Actions."}'
